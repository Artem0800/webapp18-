<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
/* –í–∞—à–∏ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ–±–æ–ª—å—à–∏–µ –ø—Ä–∞–≤–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
body {
  font-family: "Segoe UI", sans-serif;
  background: #1e1e1e;
  margin: 0;
  padding: 0;
  color: #f0f0f0;
  overflow-x: hidden;
}

main {
  max-width: 90%;
  width: 700px;
  margin: 20px auto;
  padding: 25px;
  background: #2a2a2a;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.4);
  animation: formIn 1s ease forwards;
}

h1 { text-align: center; margin-bottom: 25px; font-size: 1.5rem; }

/* –ó–í–ï–ó–î–´ */
.rating { display: flex; flex-direction: row-reverse; justify-content: center; gap: 8px; margin-bottom: 25px; }
.rating input { display: none; }
.rating label { font-size: 34px; color: #555; cursor: pointer; transition: color .2s ease; }
.rating label:hover, .rating label:hover ~ label { color: #ff4081; }
.rating input:checked ~ label { color: #ff4081; }

/* –§–û–†–ú–ê */
.form-group { margin-bottom: 20px; }
textarea {
  width: 100%; min-height: 120px; background: #1e1e1e; border: 1px solid #444;
  border-radius: 12px; padding: 14px; color: #fff; font-size: 15px; resize: vertical; box-sizing: border-box;
}
textarea:focus { outline: none; border-color: #ff4081; }

/* –§–û–¢–û –ò –ö–ù–û–ü–ö–ò */
.file-upload { position: relative; width: 100%; }
.file-upload input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
.file-upload-label {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  padding: 16px; border-radius: 14px; background: transparent;
  border: 2px dashed rgba(255, 255, 255, 0.25); color: #ccc; cursor: pointer; transition: all .25s ease;
}
.file-upload-label:hover { border-color: #ff4081; color: #ff4081; background: rgba(255, 64, 129, 0.08); }

.preview { position: relative; margin-top: 15px; display: none; }
.preview img { max-width: 100%; border-radius: 12px; }
.remove-photo {
  position: absolute; top: 10px; right: 10px; width: 34px; height: 34px;
  border-radius: 50%; background: rgba(255,64,129,.8); color: #fff; border: none; cursor: pointer;
}

button#submitBtn {
  width: 100%; padding: 14px; border: none; border-radius: 50px;
  font-size: 1rem; font-weight: 600; cursor: pointer;
  background: linear-gradient(90deg, #ff4081, #c2185b); color: #fff;
  box-shadow: 0 6px 20px rgba(255,64,129,.35); transition: .2s;
}
button#submitBtn:disabled { filter: grayscale(1); cursor: not-allowed; }

.toast {
  position: fixed; bottom: 30px; left: 50%; transform: translate(-50%, 20px);
  background: #ff4081; color: #fff; padding: 12px 24px; border-radius: 50px;
  opacity: 0; transition: all 0.3s ease; z-index: 10000; pointer-events: none;
}
.toast.show { opacity: 1; transform: translate(-50%, 0); }

@keyframes formIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<main>
  <h1 id="welcomeText">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h1>

  <div class="rating">
    <input type="radio" id="star5" name="rating" value="5"><label for="star5">‚òÖ</label>
    <input type="radio" id="star4" name="rating" value="4"><label for="star4">‚òÖ</label>
    <input type="radio" id="star3" name="rating" value="3"><label for="star3">‚òÖ</label>
    <input type="radio" id="star2" name="rating" value="2"><label for="star2">‚òÖ</label>
    <input type="radio" id="star1" name="rating" value="1"><label for="star1">‚òÖ</label>
  </div>

  <div class="form-group">
    <textarea class="review-textarea" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤..."></textarea>
  </div>

  <div class="form-group">
    <div class="file-upload">
      <label for="photo" class="file-upload-label" id="uploadLabel">
        <span class="icon">üì∏</span>
        <span id="uploadText">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é</span>
      </label>
      <input type="file" accept="image/*" id="photo">
    </div>
    <div class="preview" id="preview"></div>
  </div>

  <button type="button" id="submitBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
</main>

<div id="toast" class="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤—Å–µ –æ–∫–Ω–æ
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = tg.initDataUnsafe?.user;
    const username = user ? (user.username || user.first_name) : "–ê–Ω–æ–Ω–∏–º";

    const photoInput = document.getElementById('photo');
    const preview = document.getElementById('preview');
    const uploadText = document.getElementById('uploadText');
    const textarea = document.querySelector('.review-textarea');
    const submitButton = document.getElementById('submitBtn');
    const toast = document.getElementById('toast');

    function showToast(message) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function showImage(file) {
        preview.innerHTML = '';
        if (!file.type.startsWith('image/')) {
            showToast('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            return;
        }
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-photo';
        removeBtn.innerHTML = '√ó';
        removeBtn.onclick = () => {
            photoInput.value = '';
            preview.style.display = 'none';
            uploadText.textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é';
        };
        preview.appendChild(img);
        preview.appendChild(removeBtn);
        preview.style.display = 'block';
        uploadText.textContent = '–§–æ—Ç–æ –≤—ã–±—Ä–∞–Ω–æ';
    }

    photoInput.addEventListener('change', () => {
        if (photoInput.files[0]) showImage(photoInput.files[0]);
    });

    submitButton.addEventListener('click', async () => {
        const starInputs = document.querySelectorAll('input[name="rating"]');
        let ratingValue = '';
        starInputs.forEach(input => { if (input.checked) ratingValue = input.value; });

        const text = textarea.value.trim();

        if (!ratingValue) return showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ü–µ–Ω–∫—É');
        if (!text) return showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞');

        let imgBase64 = '';
        if (photoInput.files[0]) {
            const reader = new FileReader();
            imgBase64 = await new Promise(r => {
                reader.onload = () => r(reader.result);
                reader.readAsDataURL(photoInput.files[0]);
            });
        }

        const reviewData = {
            count_reviews: ratingValue.toString(),
            text: text,
            img: imgBase64,
            username: username // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º—è –∏–∑ Telegram
        };

        try {
            submitButton.disabled = true;
            submitButton.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

            const response = await fetch('http://127.0.0.1:8000/add_to_reviews', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reviewData)
            });

            if (!response.ok) throw new Error();

            showToast('–°–ø–∞—Å–∏–±–æ! –û—Ç–∑—ã–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
            
            // –ñ–¥–µ–º 1.5 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª Toast, –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º WebApp
            setTimeout(() => {
                tg.close();
            }, 1500);

        } catch (err) {
            submitButton.disabled = false;
            submitButton.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤';
            showToast('–û—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        }
    });
});
</script>
</body>
</html>
